/*OWOP JS*/
(()=>{window=this;const e=e=>console.error("%c "+e,"color: #ff0000"),t=()=>new Promise(e=>{OWOP.windowSys.addWindow(new OWOP.windowSys.class.window("Verification needed",{closeable:!0},function(t){grecaptcha.render(t.addObj(OWOP.util.mkHTML("div",{})),{theme:"dark",sitekey:"6LcgvScUAAAAAARUXtwrM8MP0A0N70z4DHNJh-KI",callback:function(n){t.close(),e(n)}})}))});class n{constructor(){this.chunks=[],this.chunkProtected=[]}setChunk(t,n,o){return o&&"number"==typeof t&&"number"==typeof n?("Array"!==o.constructor.name&&(o=Array.from(o)),this.chunks[t]||(this.chunks[t]=[]),this.chunks[t][n]=o):e("ChunkSystem.setChunk: failed to set chunk (no data or invalid coords).")}getChunk(e,t,n){if(n||(e=Math.floor(e/r.options.chunkSize),t=Math.floor(t/r.options.chunkSize)),this.chunks[e])return this.chunks[e][t]}removeChunk(e,t){if(this.chunks[e]&&this.chunks[e][t])return this.chunks[e].splice(t,1)}setPixel(t,n,o){if(!o||"object"!=typeof o||"number"!=typeof t||"number"!=typeof n)return e("ChunkSystem.setPixel: failed to set pixel (no/wrong rgb or invalid coords).");const s=Math.floor(t/r.options.chunkSize),i=Math.floor(n/r.options.chunkSize);if(!this.chunks[s])return;const a=this.chunks[s][i];if(!a)return!1;const c=((e,t,n)=>3*(t*n+e))(t&r.options.chunkSize-1,n&r.options.chunkSize-1,r.options.chunkSize);return a[c]=o[0],a[c+1]=o[1],a[c+2]=o[2],!0}getPixel(t,n){if("number"!=typeof t||"number"!=typeof n)return e("ChunkSystem.getPixel: failed to get pixel (invalid coords).");const o=Math.floor(t/r.options.chunkSize),s=Math.floor(n/r.options.chunkSize);if(!this.chunks[o])return;const i=this.chunks[o][s],a=((e,t,n)=>3*(t*n+e))(t&r.options.chunkSize-1,n&r.options.chunkSize-1,r.options.chunkSize);return[i[a],i[a+1],i[a+2]]}protectChunk(t,n){return"number"!=typeof t||"number"!=typeof n?e("ChunkSystem.protectChunk: failed to protect chunk (invalid coords)."):(this.chunkProtected[t]||(this.chunkProtected[t]=[]),this.chunkProtected[t][n]=!0)}unProtectChunk(t,n){return"number"!=typeof t||"number"!=typeof n?e("ChunkSystem.unprotectChunk: failed to unprotect chunk (invalid coords)."):!!this.chunkProtected[t]&&(this.chunkProtected[t][n]=!1,!0)}isProtected(t,n){return"number"!=typeof t||"number"!=typeof n?e("ChunkSystem.isProtected: failed to check (invalid coords)."):!!this.chunkProtected[t]&&Boolean(this.chunkProtected[t][n])}}const o=new n;class r{constructor(n={}){n.ws||(n.ws="wss://ourworldofpixels.com"),n.world||(n.world="main"),n.reconnectTime||(n.reconnectTime=5e3);const r=this;this.clientOptions=n,this.RANK={ADMIN:3,MODERATOR:2,USER:1,NONE:0},this.options={chunkSize:16,maxChatBuffer:256,maxMessageLength:{0:128,1:128,2:512,3:16384},maxWorldNameLength:24,worldBorder:16777215,opcode:{setId:0,worldUpdate:1,chunkLoad:2,teleport:3,setRank:4,captcha:5,setPQuota:6,chunkProtected:7},captchaState:{CA_WAITING:0,CA_VERIFYING:1,CA_VERIFIED:2,CA_OK:3,CA_INVALID:4},captchaStateNames:{0:"WAITING",1:"VERIFYING",2:"VERIFIED",3:"OK",4:"INVALID"}},void 0===window.document?this.options.misc={chatVerification:String.fromCharCode(10),tokenVerification:"CaptchA",worldVerification:25565}:this.options.misc={chatVerification:OWOP.options.serverAddress[0].proto.misc.chatVerification,tokenVerification:OWOP.options.serverAddress[0].proto.misc.tokenVerification,worldVerification:OWOP.options.serverAddress[0].proto.misc.worldVerification},r.chat={send:e=>"number"==typeof r.player.rank&&(e=r.chat.sendModifier(e),r.net.ws.send(e.substr(0,r.options.maxMessageLength[r.player.rank])+r.options.misc.chatVerification),!0),local(e){r.util.log(e)},sendModifier:e=>e,recvModifier:e=>e,messages:[]},r.world={join(e="main"){if(1!==r.net.ws.readyState||!r.net.isWebsocketConnected)return!1;let t=[];e=e.toLowerCase();for(let n=0;n<e.length&&n<24;n++){let o=e.charCodeAt(n);(o<123&&o>96||o<58&&o>47||95===o||46===o)&&t.push(o)}let n=new ArrayBuffer(t.length+2),o=new DataView(n);for(let e=t.length;e--;)o.setUint8(e,t[e]);return o.setUint16(t.length,r.options.misc.worldVerification,!0),r.net.ws.send(n),r.util.log(`Joining world: ${e}`),r.world.name=e,!0},leave(){r.net.isWorldConnected=!1,r.net.isWebsocketConnected=!1,r.net.ws.close()},destroy(){r.net.isWorldConnected=!1,r.net.isWebsocketConnected=!1,r.net.destroyed=!0,r.net.ws.close(),r.emit("destroy")},move(e=0,t=0){if(1!==r.net.ws.readyState||!r.net.isWebsocketConnected)return!1;r.player.x=e,r.player.y=t,e*=16,t*=16;const n=new DataView(new ArrayBuffer(12));return r.player.worldX=e,r.player.worldY=t,n.setInt32(0,e,!0),n.setInt32(4,t,!0),n.setUint8(8,r.player.color[0]),n.setUint8(9,r.player.color[1]),n.setUint8(10,r.player.color[2]),n.setUint8(11,r.player.tool),r.net.ws.send(n.buffer),!0},setPixel(e=r.player.x,t=r.player.y,n=r.player.color,o,s=!0){if(1!==r.net.ws.readyState||!r.net.isWebsocketConnected||r.player.rank===r.RANK.NONE)return!1;if(!r.net.bucket.canSpend(1))return!1;const i=r.player.x,a=r.player.y;s&&r.world.move(e,t);const c=new DataView(new ArrayBuffer(11));return c.setInt32(0,e,!0),c.setInt32(4,t,!0),c.setUint8(8,n[0]),c.setUint8(9,n[1]),c.setUint8(10,n[2]),r.player.color=n,r.net.ws.send(c.buffer),o&&r.world.move(i,a),!0},setTool(e=0){if(1!==r.net.ws.readyState||!r.net.isWebsocketConnected)return!1;r.player.tool=e;const t=new DataView(new ArrayBuffer(12));return t.setInt32(0,r.player.worldX,!0),t.setInt32(4,r.player.worldY,!0),t.setUint8(8,r.player.color[0]),t.setUint8(9,r.player.color[1]),t.setUint8(10,r.player.color[2]),t.setUint8(11,e),r.net.ws.send(t.buffer),!0},setColor(e=[0,0,0]){if(1!==r.net.ws.readyState||!r.net.isWebsocketConnected)return!1;r.player.color=e;const t=new DataView(new ArrayBuffer(12));return t.setInt32(0,r.player.worldX,!0),t.setInt32(4,r.player.worldY,!0),t.setUint8(8,r.player.color[0]),t.setUint8(9,r.player.color[1]),t.setUint8(10,r.player.color[2]),t.setUint8(11,r.player.tool),r.net.ws.send(t.buffer),!0},protectChunk(e=r.player.x,t=r.player.y,o=1){if(1!==r.net.ws.readyState||!r.net.isWebsocketConnected)return!1;if(r.player.rank<r.RANK.ADMIN&&!n.unsafe)return!1;const s=new DataView(new ArrayBuffer(10));return s.setInt32(0,e,!0),s.setInt32(4,t,!0),s.setUint8(8,o),r.net.ws.send(s.buffer),!0},clearChunk(e=r.player.x,t=r.player.y,o=r.player.color){if(r.player.rank===r.RANK.ADMIN||n.unsafe){const n=new DataView(new ArrayBuffer(13));return n.setInt32(0,e,!0),n.setInt32(4,t,!0),n.setUint8(8,o[0]),n.setUint8(9,o[1]),n.setUint8(10,o[2]),r.net.ws.send(n.buffer),!0}return!1},requestChunk(e,t,o){if(n.simpleChunks)return!0;if(1!==r.net.ws.readyState||!r.net.isWebsocketConnected)return!1;"number"!=typeof e&&"number"!=typeof t&&(e=r.player.x,t=r.player.y,o=!0),o&&(e=Math.floor(e/r.options.chunkSize),t=Math.floor(t/r.options.chunkSize));let s=r.options.worldBorder;if(e>s||t>s||e<~s||t<~s)return;let i=new DataView(new ArrayBuffer(8));return i.setInt32(0,e,!0),i.setInt32(4,t,!0),r.net.ws.send(i.buffer),!0},getPixel:(e=r.player.x,t=r.player.y)=>n.simpleChunks?OWOP.world.getPixel(e,t):(o.getChunk(e,t)||r.world.requestChunk(e,t,!0),o.getPixel(e,t))},r.player={x:0,y:0,worldX:0,worldY:0,tool:0,rank:null,id:null,color:[0,0,0]},r.players={},r.net={isWebsocketConnected:!1,isWorldConnected:!1,destroyed:!1,bucket:new s(32,4),async dataHandler(i){if("object"!=typeof i)return e("Client.net.dataHandler: data is not object.");const a=i;switch((i=new DataView(i)).getUint8(0)){case r.options.opcode.setId:r.emit("id",i.getUint32(1,!0)),r.player.id=i.getUint32(1,!0),r.net.isWorldConnected=!0,"number"!=typeof r.player.rank&&(r.player.rank=r.RANK.NONE),r.util.log(`Joined world '${r.world.name}' and got id '${i.getUint32(1,!0)}'`,"color: #00ff00"),n.adminlogin&&r.chat.send("/adminlogin "+n.adminlogin),n.modlogin&&r.chat.send("/modlogin "+n.modlogin),n.pass&&r.chat.send("/pass "+n.pass),r.emit("join",r.world.name);break;case r.options.opcode.worldUpdate:{let e=!1,t={};for(let n=i.getUint8(1);n--;){e=!0;let o=i.getUint32(2+16*n,!0);if(o===r.player.id)continue;let s=i.getUint32(2+16*n+4,!0),a=i.getUint32(2+16*n+8,!0),c=i.getUint8(2+16*n+12),l=i.getUint8(2+16*n+13),d=i.getUint8(2+16*n+14),h=i.getUint8(2+16*n+15);t[o]={x:s,y:a,rgb:[c,l,d],tool:h}}if(e)for(let e in t)r.players[e]||r.emit("connect",e),r.players[e]={id:e,x:t[e].x>>4,y:t[e].y>>4,rgb:t[e].rgb,tool:t[e].tool},r.emit("update",r.players[e]);let n=2+16*i.getUint8(1);for(let e=i.getUint16(n,!0),t=0;t<e;t++){let e=i.getInt32(2+n+15*t+4,!0),s=i.getInt32(2+n+15*t+8,!0),a=i.getUint8(2+n+15*t+12),c=i.getUint8(2+n+15*t+13),l=i.getUint8(2+n+15*t+14);r.emit("pixel",e,s,[a,c,l]),o.setPixel(e,s,[a,c,l])}n+=15*i.getUint16(n,!0)+2;for(let e=i.getUint8(n);e--;){let t=i.getUint32(1+n+4*e,!0);r.players[t]&&(r.emit("disconnect",r.players[t]),delete r.players[t])}break}case r.options.opcode.chunkLoad:{let e=i.getInt32(1,!0),t=i.getInt32(5,!0),n=!!i.getUint8(9),s=new Uint8Array(a,10,a.byteLength-10),c=r.util.decompress(s);o.setChunk(e,t,c),n&&o.protectChunk(e,t),r.emit("chunk",e,t,c,n);break}case r.options.opcode.teleport:{if(!n.teleport)break;const e=i.getInt32(1,!0),t=i.getInt32(5,!0);r.world.move(e,t),r.emit("teleport",e,t);break}case r.options.opcode.setRank:r.player.rank=i.getUint8(1),r.emit("rank",i.getUint8(1));break;case r.options.opcode.captcha:switch(i.getUint8(1)){case r.options.captchaState.CA_WAITING:r.util.log("CaptchaState: WAITING (0)","color: #ffff00"),n.captchapass?(r.net.ws.send(r.options.misc.tokenVerification+"LETMEINPLZ"+n.captchapass),r.util.log("Used captchapass.","color: #00ff00")):n.renderCaptcha&&this.net.ws.send(OWOP.options.serverAddress[0].proto.misc.tokenVerification+await t());break;case r.options.captchaState.CA_VERIFYING:r.util.log("CaptchaState: VERIFYING (1)","color: #ffff00");break;case r.options.captchaState.CA_VERIFIED:r.util.log("CaptchaState: VERIFIED (2)","color: #00ff00");break;case r.options.captchaState.CA_OK:r.util.log("CaptchaState: OK (3)","color: #00ff00"),r.world.join(n.world);break;case r.options.captchaState.CA_INVALID:r.util.log("CaptchaState: INVALID (4)","color: #ff0000"),r.util.log("Captcha failed. Websocket is invalid now.","color: #ff0000"),r.net.destroyed=!0,r.net.isWorldConnected=!1,r.net.isWebsocketConnected=!1,r.emit("destroy")}r.emit("captcha",i.getUint8(1));break;case r.options.opcode.setPQuota:{let e=i.getUint16(1,!0),t=i.getUint16(3,!0);r.net.bucket=new s(e,t),r.emit("pquota",e,t),r.util.log(`New PQuota: ${e}x${t}`);break}case r.options.opcode.chunkProtected:{let e=i.getInt32(1,!0),t=i.getInt32(5,!0),n=i.getUint8(9);n?o.protectChunk(e,t):o.unProtectChunk(e,t),r.emit("chunkProtect",e,t,n);break}}},messageHandler(t){if("string"!=typeof t)return e("Client.net.messageHandler: data is not string.");if(t.startsWith("You are banned"))return r.util.log("Got ban message.","color: #ff0000"),r.emit("destroy"),r.net.isWorldConnected=!1,r.net.isWebsocketConnected=!1,r.net.destroyed=!0;if(t.startsWith("DEV")&&r.util.log("[DEV] "+t.slice(3)),t.startsWith("<"))return;(t=r.chat.recvModifier(t)).split(":")[0];r.emit("message",t),r.chat.messages.push(t),r.chat.messages.length>r.options.maxChatBuffer&&r.chat.messages.shift()}},function e(){let t=new WebSocket(n.ws);t.binaryType="arraybuffer",t.onopen=(()=>{r.util.log("WebSocket connected!","color: #00ff00"),r.net.isWebsocketConnected=!0,r.emit("open")}),t.onmessage=(e=>{r.emit("rawMessage",e.data),"string"==typeof e.data?r.net.messageHandler(e.data):"object"==typeof e.data&&r.net.dataHandler(e.data)}),t.onclose=(()=>{r.emit("close"),r.util.log("WebSocket disconnected!","color: #ff0000"),r.net.isWorldConnected=!1,r.net.isWebsocketConnected=!1,n.reconnect&&!r.net.destroyed&&setTimeout(e,n.reconnectTime)}),t.onerror=(()=>{r.util.log("WebSocket error!","color: #ff0000"),r.net.isWorldConnected=!1,r.net.isWebsocketConnected=!1}),r.net.ws=t}(),r.util={log(...e){n.noLog||(n.id?console.log(`[${n.id}] ${e}`):r.player.id?console.log(`%c [${r.player.id}] `+e[0],e[1]):console.log("%c [?] "+e[0],e[1]))},decompress(e){for(var t=e[1]<<8|e[0],n=new Uint8Array(t),o=e[3]<<8|e[2],r=2*o+4,s=0,i=r,a=0;a<o;a++){for(var c=(e[4+2*a+1]<<8|e[4+2*a])+r;i<c;)n[s++]=e[i++];var l=e[i+1]<<8|e[i],d=e[i+2],h=e[i+3],p=e[i+4];for(i+=5;l--;)n[s]=d,n[s+1]=h,n[s+2]=p,s+=3}for(;i<e.length;)n[s++]=e[i++];return n}},n.unsafe&&r.util.log("Using 'unsafe' option.","color: #ffff00"),this._events={}}on(e,t){this._events[e]||(this._events[e]=[]),this._events[e].push(t)}once(e,t){this._events[e]||(this._events[e]=[]),this._events[e].push([t])}emit(e,...t){if(this._events[e])for(let n in this._events[e])"function"==typeof this._events[e][n]?this._events[e][n](...t):(this._events[e][n][0](...t),this._events[e].splice(n,1))}off(e,t){if(this._events[e])for(let n in this._events[e])String(this._events[e][n])===String(t)&&this._events[e].splice(n,1)}}r.RANK={ADMIN:3,MODERATOR:2,USER:1,NONE:0},r.options={chunkSize:16,maxChatBuffer:256,maxMessageLength:{0:128,1:128,2:512,3:16384},maxWorldNameLength:24,worldBorder:16777215,opcode:{setId:0,worldUpdate:1,chunkLoad:2,teleport:3,setRank:4,captcha:5,setPQuota:6,chunkProtected:7},captchaState:{CA_WAITING:0,CA_VERIFYING:1,CA_VERIFIED:2,CA_OK:3,CA_INVALID:4},captchaStateNames:{0:"WAITING",1:"VERIFYING",2:"VERIFIED",3:"OK",4:"INVALID"}},void 0===window.document?r.options.misc={chatVerification:String.fromCharCode(10),tokenVerification:"CaptchA",worldVerification:25565}:r.options.misc={chatVerification:OWOP.options.serverAddress[0].proto.misc.chatVerification,tokenVerification:OWOP.options.serverAddress[0].proto.misc.tokenVerification,worldVerification:OWOP.options.serverAddress[0].proto.misc.worldVerification};class s{constructor(e,t,n){this.lastCheck=Date.now(),this.allowance=e,this.rate=e,this.time=t,this.infinite=n}update(){this.allowance+=(Date.now()-this.lastCheck)/1e3*(this.rate/this.time),this.lastCheck=Date.now(),this.allowance>this.rate&&(this.allowance=this.rate)}canSpend(e){return!!this.infinite||(this.update(),!(this.allowance<e)&&(this.allowance-=e,!0))}}console.log("OJS loaded")})();


function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
}

const Client = new OJS.Client({
    reconnect: true
});

Client.on("join", () => {
    Client.chat.send("/nick Dragon")
});

Client.on("message", msg => {
            var msget = msg
            if (msget.includes("d!help")) {
                Client.chat.send("Bot commands here: ");
                Client.chat.send("https://pastebin.com/raw/xfeDn6Dc");
            }
            if (msget.includes("d!opensource")) {
                Client.chat.send("Dragon Chat Bot open source: https://github.com/ntloff/owop-dragon-chat-bot/blob/main/index.js");
                Client.chat.send("Fork (opm-less): https://github.com/SuperPowerPlumber/dragon-chat-bot-no-opm/blob/main/index.js");
            }
            if (msget.includes("d!owopdiscord")) {
                Client.chat.send("OWOP Discord: https://discord.gg/kEXkhPT4CT");
            }
            if (msget.includes("d!randomnum")) {
                var randomnum = getRandomInt("1", "100");
                Client.chat.send(randomnum);
            }
});
